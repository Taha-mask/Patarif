<!-- HTML (Angular template) -->
<div class="background">
    <div class="main card-popup">

        <form [formGroup]="productForm" (ngSubmit)="submitProduct()" class="d-flex flex-column h-100">

            <div class="form-body flex-grow-1 overflow-auto p-container">
                <div class="row gap-3 justify-content-evenly align-items-start form-grid fields-box">

                    <div class="form-field col-auto">
                        <i class="bi bi-tag-fill field-icon" aria-hidden="true"></i>
                        <input class="form-control" placeholder="Title" type="text" formControlName="title">
                    </div>

                    <div class="form-field col-auto">
                        <i class="bi bi-card-text field-icon" aria-hidden="true"></i>
                        <input class="form-control" placeholder="Subtitle" type="text" formControlName="subtitle">
                    </div>

                    <div class="form-field col-auto">
                        <i class="bi bi-currency-dollar field-icon" aria-hidden="true"></i>
                        <input class="form-control" placeholder="Price" type="number" min="0" formControlName="price">
                    </div>

                    <div class="form-field col-auto">
                        <i class="bi bi-tags field-icon" aria-hidden="true"></i>
                        <input class="form-control" placeholder="discount mount" type="number" min="0"
                            formControlName="discount">
                    </div>

                    <div class="form-field col-auto">
                        <!-- <i class="bi bi-currency-dollar field-icon" aria-hidden="true"></i> -->
                        <input class="form-control" readonly placeholder="final price" type="number" min="0"
                            formControlName="final_price" [value]="updateFinalPrice()">
                    </div>

                    <div class="form-field col-auto">
                        <i class="bi bi-box-seam field-icon" aria-hidden="true"></i>
                        <input class="form-control" placeholder="Stock" type="number" min="0" formControlName="stock">
                    </div>

                    <div class="form-field col-12 col-md-auto">
                        <i class="bi bi-file-earmark-text field-icon" aria-hidden="true"></i>
                        <input class="form-control" placeholder="Description" type="text" formControlName="description">
                    </div>

                    <div class="form-field col-auto">
                        <i class="bi bi-code-slash field-icon" aria-hidden="true"></i>
                        <input class="form-control" placeholder="Code" type="text" formControlName="code">
                    </div>

                    <div class="form-field col-auto">
                        <i class="bi bi-list-ul field-icon" aria-hidden="true"></i>
                        <select class="form-control categories" id="category" formControlName="category">
                            <option value="t-shirts">t-shirts</option>
                            <option value="shirts">shirts</option>
                            <option value="pants">pants</option>
                            <option value="other">other</option>
                        </select>
                    </div>

                    <div class="form-field col-auto">
                        <i class="bi bi-star-fill field-icon" aria-hidden="true"></i>
                        <input class="form-control" placeholder="First rate" type="number" max="5" min="0"
                            formControlName="firstRate">
                    </div>

                </div>

                <hr class="my-3">

                <!-- Colors Section -->
                <div formArrayName="colors" class="colors-section">
                    <div *ngFor="let color of colors.controls; let i = index" [formGroupName]="i"
                        class="mb-3 color-card p-3 rounded">
                        <div class="d-flex gap-2 align-items-center">

                            <!-- Text Input for color_name -->
                            <div class="form-field w-auto me-2">
                                <i class="bi bi-palette field-icon" aria-hidden="true"></i>
                                <input placeholder="Color" type="text" formControlName="color_name"
                                    class="form-control">
                            </div>

                            <!-- Color Picker bound to color_code -->
                            <div class="form-field w-auto">
                                <input type="color" class="form-control form-control-color"
                                    formControlName="color_code">
                            </div>

                            <button type="button" class="btn btn-outline-danger btn-sm ms-auto"
                                (click)="removeColor(i)">
                                <i class="bi bi-trash"></i> Remove
                            </button>
                        </div>

                        <!-- Sizes Section -->
                        <div formArrayName="sizes" class="mt-3">
                            <div *ngFor="let size of getSizes(i).controls; let j = index" [formGroupName]="j"
                                class="d-flex gap-2 mb-2 align-items-center">
                                <div class="form-field small-field">
                                    <i class="bi bi-rulers field-icon" aria-hidden="true"></i>
                                    <input placeholder="Size" type="text" formControlName="size_name"
                                        class="form-control">
                                </div>

                                <div class="form-field small-field">
                                    <i class="bi bi-stack field-icon" aria-hidden="true"></i>
                                    <input placeholder="Stock" type="number" min="0" formControlName="stock"
                                        class="form-control">
                                </div>

                                <button type="button" class="btn btn-outline-danger btn-sm" (click)="removeSize(i, j)">
                                    <i class="bi bi-x-lg"></i>
                                </button>
                            </div>

                            <button type="button" class="btn btn-outline-primary btn-sm" (click)="addSize(i)">
                                <i class="bi bi-plus-lg"></i> Add Size
                            </button>
                        </div>
                    </div>
                </div>


                <button type="button" class="btn btn-outline-success mt-2 me-2" (click)="addColor()"><i
                        class="bi bi-plus-lg"></i> Add Color</button>

                <hr class="my-3">
                <!-- IMAGE DROPZONE / SELECTOR (full width) -->
                <div class="image-dropzone-wrapper w-100">
                    <!-- hidden file input (Angular event hook) -->
                    <input type="file" id="productImages" accept="image/*" multiple hidden
                        (change)="onFilesSelected($event)">

                    <!-- label acts as the visible drop/select area -->
                    <label for="productImages"
                        class="image-dropzone d-flex flex-column align-items-center justify-content-center gap-2">
                        <i class="bi bi-images drop-icon" aria-hidden="true"></i>
                        <div class="drop-text">Select images</div>
                        <div class="drop-subtext">or drag & drop images here</div>
                    </label>
                </div>

                <!-- Preview images -->
                <div class="image-previews d-flex flex-wrap gap-2 mt-3">
                    <div *ngFor="let url of previewUrls; let i = index" class="preview-img-wrapper position-relative">
                        <img [src]="url" alt="preview" class="preview-img" />
                        <button type="button" class="btn btn-sm btn-danger remove-btn"
                            (click)="removeImage(i)">Ã—</button>
                    </div>
                </div>

            </div> <!-- end form-body -->

            <!-- footer buttons -->
            <div class="form-footer d-flex justify-content-end gap-2 align-items-center p-footer">
                <button type="button" class="btn btn-secondary" (click)="close()"><i class="bi bi-x-circle"></i>
                    Discard</button>
                <button type="submit" class="btn btn-primary btn-save"><i class="bi bi-check-lg"></i> Save
                    Product</button>
            </div>

        </form>

    </div>
</div>